# Security Audit Report - Tetrivo (2026-01-20)

## Scope
- Repository: `C:\Users\xboxs\Documents\tetra`
- Static review of app code, API routes, Supabase SQL migrations, and runtime config in repo.
- Out of scope: runtime infrastructure settings (Supabase/Vercel), secrets, third-party systems, compiled artifacts.

## Method
- Manual code review + pattern scans for auth, RLS, storage, secrets, logging, and privacy risks.
- No runtime tests or dependency scans were executed.
- Findings based on static inspection; verify in staging/production.

## Risk rating scale
- Critical: likely compromise or cross-tenant exposure.
- High: major security/privacy or availability risk.
- Medium: moderate risk or defense-in-depth gaps.
- Low: minor risk or best practice.

## Executive summary
- Critical: 1
- High: 4
- Medium: 6
- Low/Info: 5
- Primary risks: RLS policy consolidation, open endpoints without abuse controls, monitoring gaps, data minimization.

## Findings

### Critical
F-01: Profiles update RLS is still permissive due to multiple policies
- Impact: privilege escalation (role/org/team update).
- Evidence: `supabase/sql/05_policy_updates.sql`, `supabase/sql/14_rls_optimization.sql`, `supabase/sql/30_profiles_update_lock.sql`
- Details: `30_profiles_update_lock.sql` introduces a stricter WITH CHECK policy, but older update policies are not dropped, so permissive policies can still allow role/org/team changes. Supabase evaluates permissive policies with OR semantics.
- Recommendation: Drop older UPDATE policies for `profiles` and keep only the locked policy; verify active policies in production.

### High
F-02: Contact endpoint blocked by auth middleware
- Impact: public contact form fails; users see redirects; may prompt insecure workarounds.
- Evidence: `src/middleware.ts`, `src/app/api/contact/route.ts`, `src/app/page.tsx`
- Recommendation: Exclude `/api/contact` from middleware auth or move to external service with signed token.

F-03: Health check likely always returns 503
- Impact: monitoring false positives; hides real outages.
- Evidence: `src/app/api/health/route.ts`, `supabase/sql/05_policy_updates.sql`
- Details: health route reads `organizations` with anon client; RLS blocks it.
- Recommendation: Use service role or a public RPC for health.

F-04: Contact endpoint lacks abuse controls
- Impact: spam/DoS and mailbox overload.
- Evidence: `src/app/api/contact/route.ts`, `src/lib/ratelimit.ts`
- Recommendation: Add rate limit + captcha/honeypot, or external form provider.

F-05: Audit logs are client-writable
- Impact: audit logs are not tamper resistant.
- Evidence: `src/lib/audit-log.ts`, `src/app/admin/hooks/useAdminInstructions.ts`
- Recommendation: Move logging to server-side API or DB trigger; remove client write paths.

### Medium
F-06: CSP allows `unsafe-inline`
- Impact: higher XSS risk if any injection occurs.
- Evidence: `next.config.ts`
- Recommendation: Use nonce or hash-based CSP.

F-07: Invite links rely on request origin
- Impact: incorrect domain if proxies are misconfigured.
- Evidence: `src/app/api/invite/route.ts`
- Recommendation: Enforce `NEXT_PUBLIC_APP_URL` or allowlist.

F-08: PII in logs and emails without minimization
- Impact: retention and privacy risk.
- Evidence: `src/app/api/contact/route.ts`, `src/app/api/invite/route.ts`, `supabase/sql/29_gdpr_retention.sql`
- Recommendation: Redact sensitive fields; document retention schedule and automate cleanup.

F-09: UI text claims email is not stored, but it is in audit logs
- Impact: compliance and expectation mismatch.
- Evidence: `src/app/admin/components/modals/InviteUserModal.tsx`, `src/lib/audit-log.ts`
- Recommendation: Update copy or reduce stored details.

F-10: AI processing lacks documented disclosure and DPA evidence
- Impact: compliance gap for personal data.
- Evidence: `src/app/api/ask/route.ts`, `src/lib/embeddings.ts`
- Recommendation: Add privacy disclosure, DPA, and data classification for AI inputs.

F-11: Observability gap (Sentry not installed)
- Impact: delayed detection and triage.
- Evidence: `RUNBOOK.md`
- Recommendation: Add error monitoring and alerting.

### Low/Info
F-12: HSTS header missing
- Evidence: `next.config.ts`
- Recommendation: Add `Strict-Transport-Security`.

F-13: Legacy `X-XSS-Protection` header
- Evidence: `next.config.ts`
- Recommendation: Remove to avoid false sense of security.

F-14: Client cookie lacks Secure/HttpOnly
- Evidence: `src/app/invite/[token]/AcceptInvite.tsx`
- Recommendation: Keep value non-sensitive or move to server session.

F-15: Rate limiter requires Upstash env
- Evidence: `src/lib/ratelimit.ts`
- Recommendation: Add deployment checks and alerts if missing.

## Positive controls
- Strong RLS foundation and security definer helpers.
- Storage uploads forced through server routes.
- File upload validation (size/type) and non-blocking embedding generation.
- GDPR cleanup functions present.

## Pilot readiness (estimate)
- Internal/closed pilot: 6/10 after fixing F-01, F-02, F-03, F-04.
- External pilot: 4.5/10 until monitoring, privacy disclosures, and retention automation are done.

## ISO 27001 gap overview (high level)
Status uses: Not started / Partial / In place
- A.5 Policies: Not started (no ISMS policy set in repo).
- A.6 Organization: Partial (roles exist, but no governance docs).
- A.7 Human resources: Not started.
- A.8 Asset management: Partial (data tables known, no inventory).
- A.9 Access control: Partial (RLS strong, but process docs missing).
- A.10 Cryptography: Partial (TLS expected, key mgmt not documented).
- A.11 Physical security: Not started (provider responsibility).
- A.12 Operations: Partial (runbook present, monitoring gaps).
- A.13 Communications: Partial (CSP/HSTS gaps).
- A.14 System acquisition/development: Partial (security fixes present).
- A.15 Supplier relationships: Not started (DPA evidence missing).
- A.16 Incident management: Not started (no IR plan).
- A.17 Business continuity: Not started (backup/restore evidence missing).
- A.18 Compliance: Partial (GDPR retention script exists).

Estimated distance: early-mid stage, roughly 30-40% of governance/evidence requirements.

## Recommended next steps (priority order)
1. Consolidate `profiles` UPDATE policies in production and verify with `pg_policies`.
2. Open `/api/contact` safely (middleware exception + rate limit/captcha).
3. Fix `/api/health` to use service role or public RPC.
4. Add error monitoring (Sentry) and uptime checks.
5. Add privacy/AI disclosures and DPA documentation.
6. Automate retention cleanup with pg_cron or scheduled job.
